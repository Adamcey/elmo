<h:html xmlns="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:h="http://www.w3.org/1999/xhtml" xmlns:jr="http://openrosa.org/javarosa" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <h:head>
    <h:title><%= @form.full_name %></h:title>
    <model>
      <instance>
        <data id="<%= @form.id %>">
          <startstamp/>
          <% @form.visible_questionings.each do |q| %>
            <%= tag(q.question.code) %>
          <% end %>
        </data>
      </instance>
      <itext>
        <% Language.active.each do |lang| %>
          <translation lang="<%= lang.code %>">
            <% @form.visible_questionings.each do |q| %>
              <text id="<%= q.question.code %>:label">
                <value><%= q.question.name(lang) %></value>
              </text>
              <text id="<%= q.question.code %>:hint">
                <value><%= q.question.hint(lang) %></value>
              </text>
            <% end %>
            <% @form.option_sets.each do |set| %>
              <% set.options.each do |opt| %>
                <text id="option<%= opt.id %>">
                  <value><%= opt.name(lang) %></value>
                </text>
              <% end %>
            <% end %>
          </translation>
        <% end %>
      </itext>
      <bind nodeset="/data/startstamp" type="dateTime" jr:preload="timestamp" jr:preloadParams="start"/>
      <% @form.visible_questionings.each do |q| %>
        <%= tag("bind", {
            'nodeset' => "/data/#{q.question.code}",
            'type' => q.question.type.odk_name,
            'required' => q.required? ? "true()" : nil,
            'relevant' => q.has_condition? ? q.condition.to_odk : nil,
            'jr:preload' => q.question.type.odk_preload,
            'jr:preloadParams' => q.question.type.odk_preload_params
           }.reject{|k,v| v.nil?}).gsub(/"required"/, '"true()"') %>
      <% end %>
    </model>
  </h:head>
  <h:body>
    <% @form.visible_questionings.each do |q| %>
      <% next if q.question.type.odk_tag.nil? %>
      <%= content_tag(q.question.type.odk_tag, :ref => "/data/#{q.question.code}") do %>
        <label ref="jr:itext('<%= q.question.code %>:label')"/>
        <hint ref="jr:itext('<%= q.question.code %>:hint')"/>
        <% if set = q.question.option_set %>
          <% set.options.each do |opt| %>
            <item>
              <label ref="jr:itext('option<%= opt.id %>')"/>
              <value><%= opt.value %></value>
            </item>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  </h:body>
</h:html>